import { Android } from '@expo/xdl';
import commandExists from 'command-exists';
import pick from 'lodash/pick';

import { Context } from '../../credentials';
import { runCredentialsManager } from '../../credentials/route';
import {
  RemoveKeystore,
  getKeystoreFromParams,
  useKeystore,
} from '../../credentials/views/AndroidKeystore';
import { SetupAndroidKeystore } from '../../credentials/views/SetupAndroidKeystore';
import BuildError from './BuildError';
import BaseBuilder from './BaseBuilder';
import prompt, { Question } from '../../prompt';
import log from '../../log';
import * as utils from './utils';
import { PLATFORMS, Platform } from './constants';

const { ANDROID } = PLATFORMS;

export default class AndroidBuilder extends BaseBuilder {
  async run(): Promise<void> {
    // Validate project
    await this.validateProject();

    // Check SplashScreen images sizes
    await Android.checkSplashScreenImages(this.projectDir);

    // Check the status of any current builds
    await this.checkForBuildInProgress();
    // Check for existing credentials, collect any missing credentials, and validate them
    await this.collectAndValidateCredentials();
    // Publish the current experience, if necessary
    let publishedExpIds = this.options.publicUrl ? undefined : await this.ensureReleaseExists();

    if (!this.options.publicUrl) {
      await this.checkStatusBeforeBuild();
    }

    // Initiate a build
    await this.build(publishedExpIds);
  }

  async validateProject() {
    await utils.checkIfSdkIsSupported(this.manifest.sdkVersion!, ANDROID);
    const androidPackage = this.manifest.android?.package;
    if (!androidPackage) {
      throw new BuildError(`Your project must have an Android package set in app.json
See https://docs.expo.io/distribution/building-standalone-apps/#2-configure-appjson`);
    }
    if (!/^[a-zA-Z][a-zA-Z0-9_]*(\.[a-zA-Z][a-zA-Z0-9_]*)+$/.test(androidPackage)) {
      throw new BuildError(
        "Invalid format of Android package name (only alphanumeric characters, '.' and '_' are allowed, and each '.' must be followed by a letter)"
      );
    }
  }

  platform(): Platform {
    return ANDROID;
  }

  async collectAndValidateCredentials(): Promise<void> {
    const ctx = new Context();
    await ctx.init(this.projectDir);

    const experienceName = `@${ctx.manifest.owner || ctx.user.username}/${ctx.manifest.slug}`;

    if (this.options.clearCredentials) {
      await runCredentialsManager(ctx, new RemoveKeystore(experienceName));
    }

    const paramKeystore = await getKeystoreFromParams(this.options);
    if (paramKeystore) {
      await useKeystore(ctx, experienceName, paramKeystore);
    } else if (await keytoolCommandExists()) {
      try {
        await runCredentialsManager(ctx, new SetupAndroidKeystore(experienceName));
      } catch (_) {
        // error is logged inside credentials manager
        // keystore will be generated by worker
      }
    } else {
      log.warn(
        'Program keytool was not found in PATH, new Keystore will be generated on Expo servers'
      );
    }
  }
}

async function keytoolCommandExists(): Promise<boolean> {
  try {
    await commandExists('keytool');
    return true;
  } catch (err) {
    return false;
  }
}
